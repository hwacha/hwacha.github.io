+++
date = '2025-03-19T15:23:36-07:00'
draft = true
title = 'Playtree Spotify Integration'
+++
Playtree uses the [Spotify API](https://developer.spotify.com/documentation/web-api) to search for tracks on Spotify, and to play music within Playtree. I also use the [Spotify Web Playback SDK](https://developer.spotify.com/documentation/web-playback-sdk), which allows for Spotify playback to occur within the app itself, and for certain events pertaining to Spotify playback to be reported real-time to the application.

Spotify API calls must be authenticated, and so I use the Authorization Code flow to obtain an access token from the server side. I need to use the access token on both the client side (because the Web Playback SDK can only be used client-side) and server side (because my server uses Spotify tokens as a proxy for the user's identity within the site). Access tokens are stored as a cookie.

The Playtree client can control Spotify playback, but playback can be controlled in certain ways on other Spotify clients as well. Playback can be transferred from the web player device to another device, a user can change the song that's playing on Spotify manually on the Spotify client, etc. The web player emits events when some of these changes occur, and I can compare the internal Playtree player state to the Spotify state as reported by the web player. With that, I can report when playback has gotten out of sync with Spotify, and offer a user the option to resync.

A subtle challenge has to do with Playtree's preferred playback flow versus Spotify's preferred flow. Spotify prefers for a user to set up a context—a playlist or an album, for example—and to automatically queue up upcoming songs to play next. Spotify even has an autoplay feature which will play related songs once a context is completed. However, Playtree instead prefers for songs to be loaded individually, only selecting the next song to play once the current song is over. A user can see on their Spotify queue what songs are coming up next; because randomness is so central to Playtree, I wanted the song that would be selected to be a surprise to the user when it first started playing. Also, if work on this project continues, a nice feature would be to allow the user to manually override random selection of the next song; thus, the next song should be open throughout the course of the currently playing song. Still, playback should move more or less seamlessly from one song to the next.

To integrate this just-in-time approach with Spotify, I had to be clever. I didn't want to poll the Spotify `/me/player` endpoint, because Spotify API calls are rate-limited. Also, I didn't want to rely on a timeout function, changing the song once the duration of the current song had elapsed, as it could easily get out of sync with the actual state of the Spotify player. So, that left the events emitted by the Spotify web player. Unlike HTML `<audio>` elements, the Spotify web player doesn't come with a dedicated `ended` event; rather, a song's completion must be inferred from other properties of playback. Certain features reliably correlated with a track's completion: the same song would be playing, except its playback would be reset to 0 and playback would be paused. I also store a timestamp on the Playtree playhead of the last time synchronized playback on a song was started. If the time elapsed since starting playback matches the time remaining on the current song, and a playback event with the right features is received, it is inferred that the song is over and that a new song should be selected.
